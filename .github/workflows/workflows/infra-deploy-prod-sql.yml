##################################################################################################
###
###  Workflow: infra-build
###
###  Description:  This workflow provisions five Azure Resources:
###                   1. Two APP VMs
###                   2. Backend MySQL DB Server
###                   3. Self-Hosted GitHub Runner
###
###                In order to join the APP VMs and MySQL DB servers to the Baker Hughes
###                Active Directory Domain a Post Provision ARM is executed on the 
###                newly provisioned VMs.  The domain template files and rpm files are
###                retrieved from a centrally managed storage account.  Additionally,
###                passwords and IDs are retieved from a central key vault.  
### 
###                The PetClinicPOC is built on a self-hosted runner as it must have 
###                access to the provisioned MySQL server in order to link the application
###                to it.
###
################################################################################################
name: workflow-prod-sql

#-----------------------------------------------------------
#--- Update resources names here as per Naming convention.
#-----------------------------------------------------------
env:
  RESOURCE_GROUP: 'RG-FEM-NONHCPROD-EASTUS-PROD'
  LOC: 'eastus'
  # INFRA_BLOB_CONTAINER: 'infra-artifacts'
  GitHubRepo: 'somagutta/BHCAzure_PetClinic'
  VM_ADMIN_USERNAME: 'bhadmin'
  SUBSCRIPTION_ID: '${{secrets.AZURE_SUBSCRIPTION_ID}}'
  AZURE_CLIENT_ID: '${{secrets.AZURE_CLIENT_ID}}'
  VNET_ID: '${{secrets.VNET_ID}}'
  GOLDEN_IMAGE_ID: '${{secrets.IMAGE_REF}}'
  virtualMachine1Name: 'BHAZW05140006P'
  virtualMachine2Name: 'BHAZW05140007P'
  virtualMachine3Name: 'BHAZW05140008P'
  VM_PASSWORD: '${{secrets.VM01_PASSWORD}}'
  NIC1_NAME: 'NIC-BHAZW02140007P-01'
  NIC2_NAME: 'NIC-BHAZW02140006P-01'
  VM_SUBNET: 'Internal-App-10.124.8.0-24'
  sql_VM_Name: 'BHAZW05120008P'
  SQL_NIC_NAME: 'NIC-BHAZW02120008P-01'
  SQL_VNET_ID: '${{secrets.VNET_ID}}'
  SQL_VNET_NAME: 'Spoke-Prod-USEast-1'
  SQL_SUBNET: 'Internal-DB-10.124.10.0-24'
  VNET_RG_NAME: 'RG-FEM-NONHCPROD-EASTUS-PROD'


 
on: 
  push:
    branches: [ develop ]
    paths:
      - 'infra/ARM/parameters/dev/**'
      - 'infra/ARM/templates/**'
      - '.github/workflows/infra-deploy-dev.yml'
  workflow_dispatch:
    branches: [ develop ]
    inputs:
      Deploy:
        description: 'Manual deployment'     
        required: true
        default: 'Manual'
permissions:
      id-token: write
      contents: read
jobs: 
  infra-deploy-dev:
    runs-on: ubuntu-latest
    environment: 
    steps:
    #--------------------
    #--- Login to Azure 
    #--------------------
    - name: Az CLI login
      uses: azure/login@v1
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          # client-id: ${{secrets.AZURE_CLIENT_ID}}
          # tenant-id: ${{secrets.AZURE_TENANT_ID}}
          # subscription-id: ${{secrets.AZURE_SUBSCRIPTION_ID}}

    - uses: actions/checkout@v2
      name: "Code checkout"
      id: codeCheckout
    
    #--------------------------------
    #--- Provision the First APP VM
    #--------------------------------
    - name: Deploy Vm BHAZW05140006P
      env:  
        DEPLOY_RES: "no"
      id: windowsVmDeploy01
      if: env.DEPLOY_RES == 'yes'
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{secrets.AZURE_SUBSCRIPTION}}
        resourceGroupName: ${{env.RESOURCE_GROUP}}
        template: ./infra/ARM/templates/WindowsVM/WindowsVm_Template.json
        parameters: ./infra/ARM/parameters/Env/prod/WindowsVM/windowsvm_parameters.json adminPassword=${{env.VM_PASSWORD}} virtualMachineName="${{env.virtualMachine1Name}}"  location=eastus virtualNetworkId="${{env.VNET_ID}}"  subnetName="${{env.VM_SUBNET}}" networkInterfaceName="${{env.NIC1_NAME}}" vnet_rg="${{env.VNET_RG_NAME}}"
    #----------------------------------
    #--- Provision the Second APP VM
    #----------------------------------
    - name: Deploy Vm BHAZW05140007P
      env: 
        DEPLOY_RES: "no"
      id: windowsVmDeploy02
      if: env.DEPLOY_RES == 'yes'
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{secrets.AZURE_SUBSCRIPTION}}
        resourceGroupName: ${{env.RESOURCE_GROUP}}
        template: ./infra/ARM/templates/WindowsVM/WindowsVm_Template.json
        parameters: ./infra/ARM/parameters/Env/prod/WindowsVM/windowsvm_parameters.json adminPassword=${{env.VM_PASSWORD}} virtualMachineName="${{env.virtualMachine2Name}}"  location=eastus virtualNetworkId="${{env.VNET_ID}}"  subnetName="${{env.VM_SUBNET}}" networkInterfaceName="${{env.NIC2_NAME}}" vnet_rg="${{env.VNET_RG_NAME}}"

    #----------------------------------
    #--- Provision the Third APP VM
    #----------------------------------
    - name: Deploy Vm BHAZW05120008P
      env: 
        DEPLOY_RES: "no"
      id: windowsVmDeploy03
      if: env.DEPLOY_RES == 'yes'
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{secrets.AZURE_SUBSCRIPTION}}
        resourceGroupName: ${{env.RESOURCE_GROUP}}
        template: ./infra/ARM/templates/WindowsVM/WindowsVm_Template.json
        parameters: ./infra/ARM/parameters/Env/prod/WindowsVM/windowsvm_parameters.json adminPassword=${{env.VM_PASSWORD}} virtualMachineName="${{env.sql_VM_Name}}"  location=eastus virtualNetworkId="${{env.VNET_ID}}"  subnetName="${{env.SQL_SUBNET}}" networkInterfaceName="${{env.SQL_NIC_NAME}}" vnet_rg="${{env.VNET_RG_NAME}}"
    #-----------------------------------
    #--- Provision the MsSQL Server
    #-----------------------------------
    - name: Azure Mssql server deploy
      env: 
        DEPLOY_RES: "yes"
      id: mssqlDeploy01
      if: env.DEPLOY_RES == 'yes'
      uses: azure/arm-deploy@v1
      with:
        subscriptionId: ${{secrets.AZURE_SUBSCRIPTION}}
        resourceGroupName: ${{env.RESOURCE_GROUP}}
        template: ./infra/ARM/templates/AzureVmWithMsSql/azurevmwithmssql_template.json
        parameters: ./infra/ARM/parameters/Env/prod/AzureVmWithMsSql/azurevmwithmssql_parameters.json adminPassword=${{secrets.SQL_ADMIN_PASSWORD}} adminUsername=${{secrets.SQL_ADMIN}}  virtualMachineName="${{env.sql_VM_Name}}" virtualNetworkName="${{env.SQL_VNET_NAME}}"  subnetName="${{env.SQL_SUBNET}}" networkInterfaceName="${{env.SQL_NIC_NAME}}" vnet_rg="${{env.VNET_RG_NAME}}"

    #--------------------
    #--- Login to Azure 
    #--------------------
    - name: Az CLI login
      uses: azure/login@v1
      with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true
          # client-id: ${{secrets.AZURE_CLIENT_ID}}
          # tenant-id: ${{secrets.AZURE_TENANT_ID}}
          # subscription-id: ${{secrets.AZURE_SUBSCRIPTION_ID}}
    #-----------------------------------
    #--- Provision the tags script
    #-----------------------------------
  
     
    - name: Run Azure PowerShell script
      env: 
        DEPLOY_RES: "yes"
      if: env.DEPLOY_RES == 'yes'   
      uses: azure/powershell@v1
      with:
        inlineScript: |
          Set-AzContext -Subscription ${{secrets.AZURE_SUBSCRIPTION_ID}}
          ./infra/Scripts/tags_script.ps
        azPSVersion: "latest"
